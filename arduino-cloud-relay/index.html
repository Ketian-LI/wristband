<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DragonLink ¬∑ Live Party Chronicle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --parchment-bg: #f5e7c6;
      --parchment-deep: #e2cf9c;
      --ink-main: #3b2b26;
      --ink-muted: #7a5c4b;
      --ink-strong: #5c3d2b;

      --block-party: #d79c5b;
      --block-dragon: #b5523b;
      --block-magic: #4f7c6b;
      --block-sky: #6f8fa7;

      --border-dark: #57402e;
      --border-light: #e0cba0;

      --shadow-soft: 0 16px 40px rgba(70, 40, 20, 0.45);
      --radius-card: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top, #f4e6c2 0, #e1cf9d 40%, #c7a774 80%),
        repeating-linear-gradient(135deg, rgba(0,0,0,0.03) 0, rgba(0,0,0,0.03) 1px, transparent 1px, transparent 4px);
      color: var(--ink-main);
      font-family: "Times New Roman", "Songti SC", "Noto Serif SC", serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .scroll-shell {
      width: 100%;
      max-width: 1120px;
      background:
        linear-gradient(145deg, rgba(255,255,255,0.78), rgba(244,225,181,0.95)),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.15) 0, rgba(255,255,255,0.15) 1px, transparent 1px, transparent 3px);
      border-radius: 22px;
      border: 2px solid var(--border-dark);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;

      /* üîí Êï¥‰∏™Âç∑ËΩ¥Âú® 16:10 Â±èÈáå‰∏ç‰ºöË¢´ÊãâÂ§™Èïø */
      max-height: 90vh;
      overflow-y: auto;
    }

    .scroll-shell::before,
    .scroll-shell::after {
      content: "";
      position: absolute;
      top: -40px;
      bottom: -40px;
      width: 32px;
      background:
        radial-gradient(circle at center, #d9b177 0, #8d5b34 65%, #3d2316 100%);
      box-shadow: inset 0 0 0 3px rgba(237,213,168,0.9);
    }

    .scroll-shell::before {
      left: -18px;
      border-radius: 999px;
    }

    .scroll-shell::after {
      right: -18px;
      border-radius: 999px;
    }

    .scroll-inner {
      position: relative;
      padding: 20px 24px 18px;
      border-left: 1px dashed rgba(87, 64, 46, 0.4);
      border-right: 1px dashed rgba(87, 64, 46, 0.4);
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: flex-start;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .title-block h1 {
      font-size: 1.4rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 600;
      color: var(--ink-strong);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-emblem {
      font-size: 1.2rem;
      border-radius: 999px;
      padding: 6px 10px;
      background: var(--block-party);
      color: #24160e;
      border: 1px solid #6e4623;
      box-shadow: 0 3px 0 #6e4623;
    }

    .subtitle {
      margin-top: 4px;
      font-size: 0.88rem;
      color: var(--ink-muted);
      max-width: 480px;
      line-height: 1.4;
    }

    .status-panel {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 2px solid var(--border-dark);
      background:
        linear-gradient(145deg, #f4e3bf, #e1c99a);
      box-shadow: 0 6px 0 rgba(87, 64, 46, 0.9);
      min-width: 230px;
    }

    .status-seal {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid #3d2316;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      background: #b83f33;
      color: #fef3c7;
      box-shadow: inset 0 0 0 2px #fcd34d, 0 0 0 3px rgba(0,0,0,0.18);
      position: relative;
    }

    .status-seal::after {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.25);
    }

    .status-texts {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .status-main {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--ink-strong);
    }

    .status-sub {
      font-size: 0.74rem;
      color: var(--ink-muted);
    }

    .status-seal.online {
      background: #3f7c45;
      box-shadow: inset 0 0 0 2px #bbf7d0, 0 0 0 3px rgba(0,0,0,0.18);
    }

    .status-seal.online span {
      transform: rotate(-10deg);
    }

    .map-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.05fr);
      gap: 18px;
      align-items: stretch;
      margin-top: 12px;
    }

    @media (max-width: 860px) {
      .map-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .scroll-inner {
        padding: 16px 12px;
      }
    }

    .panel {
      border-radius: var(--radius-card);
      border: 2px solid var(--border-dark);
      background:
        linear-gradient(145deg, var(--parchment-bg), #f2dfb2);
      box-shadow: 0 10px 0 rgba(87, 64, 46, 0.9);
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle at top left, rgba(180, 120, 70, 0.25), transparent 55%),
        url("data:image/svg+xml,%3Csvg width='160' height='160' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5 80 Q80 10 155 80 T305 80' fill='none' stroke='%23d6b47c' stroke-width='1.4' stroke-dasharray='5 4'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-size: cover, 260px 120px;
      background-position: center, bottom right;
      opacity: 0.25;
      pointer-events: none;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
      padding: 12px 14px 12px;
    }

    .panel-heading {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      gap: 8px;
    }

    .panel-title {
      font-size: 0.9rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--ink-strong);
    }

    .panel-tag {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-dark);
      background: #fef3c7;
      color: #b45309;
      box-shadow: 0 2px 0 #b45309;
      white-space: nowrap;
    }

    .block-row {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    .hero-metric {
      background: var(--block-party);
      border-radius: 14px;
      padding: 10px 12px;
      border: 2px solid #6b3b1d;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.3);
    }

    .hero-label {
      font-size: 0.74rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #3b1f0f;
      margin-bottom: 4px;
    }

    .hero-main {
      font-size: 2.1rem;
      font-weight: 700;
      display: flex;
      align-items: flex-end;
      gap: 6px;
      color: #1b0f07;
    }

    .hero-main span.unit {
      font-size: 0.92rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 3px;
      color: #3b1f0f;
    }

    .hero-side {
      background: var(--block-magic);
      border-radius: 14px;
      padding: 8px 10px;
      border: 2px solid #23453b;
      color: #ecfdf5;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .hero-side strong {
      font-size: 0.88rem;
    }

    .hero-side span {
      color: #bae6fd;
    }

    .trend-label {
      display: inline-block;
      margin-top: 4px;
      font-size: 0.74rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.58);
      color: #1b4332;
    }

    .map-frame {
      border-radius: 14px;
      border: 2px solid #324152;
      background: #f9f5e7;
      padding: 8px 8px 6px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
    }

    /* ‰∏§Âº†Âõæ‰∏ä‰∏ãÊéí + Âõ∫ÂÆöÈ´òÂ∫¶ */
    .chart-stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chart-section {
      height: 130px;      /* Âõ∫ÂÆöÈ´òÂ∫¶ */
      flex: 0 0 130px;    /* ‰∏çÂÖÅËÆ∏Êãâ‰º∏/Áº©ÊîæÔºåÈò≤Ê≠¢ÊíëÈ´òÈ°µÈù¢ */
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chart-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--ink-muted);
    }

    #chartA,
    #chartB {
      width: 100%;
      height: 100%;       /* Âè™Âç†Áî® chart-section */
    }

    .legend-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      font-size: 0.74rem;
      color: var(--ink-muted);
    }

    .side-blocks {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .mini-block-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .mini-block {
      border-radius: 12px;
      border: 2px solid var(--border-dark);
      padding: 6px 8px 7px;
      background: #f8ecd0;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
      font-size: 0.78rem;
    }

    .mini-label {
      font-size: 0.7rem;
      color: var(--ink-muted);
      margin-bottom: 2px;
    }

    .mini-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--ink-strong);
    }

    .mini-value.alt {
      color: var(--block-dragon);
    }

    .log-book {
      border-radius: 12px;
      border: 2px solid var(--border-dark);
      background:
        linear-gradient(160deg, #f6e5bf, #f1d8a2);
      padding: 6px 8px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.74rem;
      height: 160px;          /* Âõ∫ÂÆöÈ´òÂ∫¶ÔºåÂÜÖÈÉ®ÊªöÂä® */
      overflow: auto;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.12);
    }

    .log-entry {
      margin-bottom: 2px;
      color: var(--ink-main);
    }

    .log-entry span.time {
      color: var(--ink-muted);
    }

    .log-entry span.source {
      color: var(--block-dragon);
      font-weight: 600;
    }

    .log-entry span.text {
      color: var(--ink-main);
    }

    .party-logs {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .party-column {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .party-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--ink-muted);
    }
	/* --- ARCANE RELAY VISUALIZER --- */
    .relay-stage {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 20px 0;
      flex-wrap: wrap;
      gap: 20px;
    }

    .relay-unit {
      position: relative;
      width: 160px;
      height: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .relay-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--ink-muted);
      opacity: 0.3;
      pointer-events: none;
    }

    /* Common Dot Styles */
    .dot {
      position: absolute;
      border-radius: 50%;
      transition: background-color 0.1s, box-shadow 0.1s, opacity 0.1s;
    }

    /* Motor (Outer Ring) */
    .dot.motor {
      width: 14px;
      height: 14px;
      background: var(--ink-muted);
      opacity: 0.2; /* Base dim opacity */
    }

    /* Sensor (Inner Ring) */
    .dot.sensor {
      width: 10px;
      height: 10px;
      background: var(--ink-main);
      opacity: 0.2;
    }

    /* Party A Specifics */
    .relay-unit.party-A .dot.motor { box-shadow: 0 0 8px var(--block-dragon); }
    .relay-unit.party-A .dot.sensor { background: var(--block-dragon); }
    
    /* Party B Specifics */
    .relay-unit.party-B .dot.motor { box-shadow: 0 0 8px var(--block-magic); }
    .relay-unit.party-B .dot.sensor { background: var(--block-magic); }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="scroll-shell">
    <div class="scroll-inner">
      <div class="header-row">
        <div class="title-block">
          <h1>
            <span class="title-emblem">‚öîÔ∏è</span>
            DRAGONLINK SCROLL
          </h1>
          <p class="subtitle">
            Two distant adventuring parties share their status through a cloud-borne magic scroll.
            You are now watching their heartbeat, strength, and omens as they face the dragon.
          </p>
        </div>

        <div class="status-panel">
          <div id="status-seal" class="status-seal">
            <span>‚è≥</span>
          </div>
          <div class="status-texts">
            <div id="status-main" class="status-main">Linking Ritual</div>
            <div id="status-sub" class="status-sub">Summoning the cloud relay circle‚Ä¶</div>
          </div>
        </div>
      </div>

      <div class="map-grid">
	  <div class="panel" style="grid-column: span 2;"> <div class="panel-inner">
            <div class="panel-heading">
              <div class="panel-title">Arcane Relays</div>
              <div class="panel-tag">Live Haptic Feedback</div>
            </div>
            
            <div class="relay-stage">
              <div class="relay-unit party-A" id="relay-A">
                <div class="relay-label">A</div>
                </div>

              <div class="relay-unit party-B" id="relay-B">
                <div class="relay-label">B</div>
                </div>
            </div>
            
            <div class="legend-row" style="justify-content: center; gap: 20px;">
              <div>Outer Ring: 8 Motors (Output)</div>
              <div>Inner Ring: 7 Sensors (Input)</div>
            </div>
          </div>
        </div>
        <!-- Â∑¶Ôºö‰∏§‰∏™ÂõæË°® -->
        <div class="panel">
          <div class="panel-inner">
            <div class="panel-heading">
              <div class="panel-title">Dragon's Breath Gauge</div>
              <div class="panel-tag">Live ¬∑ Enchanted</div>
            </div>

            <div class="block-row">
              <div class="hero-metric">
                <div class="hero-label">CURRENT MYSTIC VALUE</div>
                <div class="hero-main">
                  <span id="main-value">--</span>
                  <span class="unit">sigils</span>
                </div>
                <div id="trend-chip" class="trend-label" style="display:none;">
                  Œî +0
                </div>
              </div>

              <div class="hero-side">
                <div>
                  <strong>Latest change</strong>
                  <span id="metric-parsed">‚Äî</span>
                </div>
                <div>
                  Source party:
                  <span id="last-source">‚Äî</span>
                </div>
                <div>
                  Last update:
                  <span id="last-timestamp">‚Äî</span>
                </div>
              </div>
            </div>

            <div class="map-frame">
              <div class="chart-stack">
                <div class="chart-section">
                  <div class="chart-title">Party A channel</div>
                  <canvas id="chartA"></canvas>
                </div>
                <div class="chart-section">
                  <div class="chart-title">Party B channel</div>
                  <canvas id="chartB"></canvas>
                </div>
              </div>

              <div class="legend-row">
                <div>Y-range fixed: -30 ~ 30</div>
                <div>Approx. last 2 minutes</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Âè≥ÔºöÊåáÊ†á + A/B Êó•Âøó -->
        <div class="panel">
          <div class="panel-inner">
            <div class="panel-heading">
              <div class="panel-title">Party Ledger</div>
              <div class="panel-tag">A ‚Üî B two-way link</div>
            </div>

            <div class="side-blocks">
              <div class="mini-block-row">
                <div class="mini-block">
                  <div class="mini-label">Total messages recorded</div>
                  <div class="mini-value alt" id="metric-count">0</div>
                </div>
                <div class="mini-block">
                  <div class="mini-label">Last parsed value</div>
                  <div class="mini-value" id="metric-parsed-mini">‚Äî</div>
                </div>
              </div>

              <div class="mini-block-row">
                <div class="mini-block">
                  <div class="mini-label">Messages from A</div>
                  <div class="mini-value" id="metric-count-A">0</div>
                </div>
                <div class="mini-block">
                  <div class="mini-label">Messages from B</div>
                  <div class="mini-value" id="metric-count-B">0</div>
                </div>
              </div>

              <div class="mini-block-row">
                <div class="mini-block">
                  <div class="mini-label">Last keyword</div>
                  <div class="mini-value" id="metric-last-key">‚Äî</div>
                </div>
                <div class="mini-block">
                  <div class="mini-label">Last party heard from</div>
                  <div class="mini-value" id="metric-last-team">‚Äî</div>
                </div>
              </div>

              <div class="party-logs">
                <div class="party-column">
                  <div class="party-title">Party A log</div>
                  <div class="log-book" id="log-A"></div>
                </div>
                <div class="party-column">
                  <div class="party-title">Party B log</div>
                  <div class="log-book" id="log-B"></div>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

<script>
    // =================================================================
    // 1. BOOTSTRAP
    // =================================================================
    document.addEventListener("DOMContentLoaded", () => {
        console.log("System Initialized.");
        initAll(); 
        connectWS(); 
    });

    // =================================================================
    // 2. CONFIGURATION
    // =================================================================
    const protocol = location.protocol === "https:" ? "wss" : "ws";
    const WS_URL = `${protocol}://${location.host}/ws`;
    
    // VISUAL SETTINGS
    const MAX_VAL = 25; // Chart and Visual max sensitivity
    const COLOR_A = "#ff6b6b"; // Bright Red/Orange
    const COLOR_B = "#4cd137"; // Bright Green

    // Global State
    let msgCounts = { total: 0, A: 0, B: 0 };
    let chartA, chartB;

    // =================================================================
    // 3. INITIALIZATION
    // =================================================================
    function initAll() {
        // --- Setup Charts ---
        const commonChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            interaction: { mode: 'none' },
            scales: {
                x: { display: false },
                y: { 
                    min: 0, 
                    max: MAX_VAL, // [CHANGED] Set to 25
                    grid: { color: "rgba(87,64,46,0.1)" },
                    ticks: { color: "#5c3d2b", stepSize: 5 } 
                }
            },
            plugins: { legend: { display: false } },
            elements: { point: { radius: 0 }, line: { borderWidth: 2 } }
        };

        const ctxA = document.getElementById("chartA");
        if (ctxA) {
            chartA = new Chart(ctxA.getContext("2d"), {
                type: "line",
                data: {
                    labels: Array(50).fill(""),
                    datasets: [{
                        data: Array(50).fill(0),
                        borderColor: COLOR_A,
                        backgroundColor: "rgba(255, 107, 107, 0.2)",
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: commonChartOptions
            });
        }

        const ctxB = document.getElementById("chartB");
        if (ctxB) {
            chartB = new Chart(ctxB.getContext("2d"), {
                type: "line",
                data: {
                    labels: Array(50).fill(""),
                    datasets: [{
                        data: Array(50).fill(0),
                        borderColor: COLOR_B,
                        backgroundColor: "rgba(76, 209, 55, 0.2)",
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: commonChartOptions
            });
        }

        // --- Build Relay Circles ---
        buildRelayDots("relay-A");
        buildRelayDots("relay-B");
    }

    function buildRelayDots(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // Label
        const labelText = containerId.includes("A") ? "A" : "B";
        container.innerHTML = `<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:1.5rem; opacity:0.3; pointer-events:none; font-weight:bold;">${labelText}</div>`;

        const radiusMotor = 70; 
        const radiusSensor = 45; 

        // Helper to create dot
        const createDot = (type, i, r) => {
            const dot = document.createElement("div");
            dot.id = `${containerId}-${type}-${i}`;
            dot.style.position = "absolute";
            dot.style.width = type === 'm' ? "14px" : "10px";
            dot.style.height = type === 'm' ? "14px" : "10px";
            dot.style.borderRadius = "50%";
            dot.style.backgroundColor = type === 'm' ? "#7a5c4b" : "#3b2b26"; // Default Off Color
            dot.style.opacity = "0.2";
            dot.style.transition = "background-color 0.1s, opacity 0.1s, box-shadow 0.1s";
            
            const angle = (i * (360 / (type==='m'?8:7))) * (Math.PI / 180);
            const x = Math.cos(angle) * r;
            const y = Math.sin(angle) * r;
            
            dot.style.left = "50%";
            dot.style.top = "50%";
            dot.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
            container.appendChild(dot);
        };

        for (let i = 0; i < 8; i++) createDot('m', i, radiusMotor); // Motors
        for (let i = 0; i < 7; i++) createDot('s', i, radiusSensor); // Sensors
    }

    // =================================================================
    // 4. LOGIC
    // =================================================================
    function interpolateTo8(inputArray) {
        if (!Array.isArray(inputArray)) return [0,0,0,0,0,0,0,0];
        const outputs = [];
        const maxInput = 6;
        const maxMotor = 7;

        for (let m = 0; m < 8; m++) {
            let pos = (m * maxInput) / maxMotor;
            let idxA = Math.min(Math.floor(pos), maxInput);
            let idxB = Math.min(idxA + 1, maxInput);
            let weight = pos - idxA;
            
            let valA = inputArray[idxA] || 0;
            let valB = inputArray[idxB] || 0;
            
            let blended = (valA * (1 - weight)) + (valB * weight);
            
            if (idxA !== idxB && valA > 5 && valB > 5) {
                let maxV = Math.max(valA, valB);
                let minV = Math.min(valA, valB);
                let factor = 1.0 - (0.5 * (minV / maxV));
                blended *= factor;
            }
            outputs.push(blended);
        }
        return outputs;
    }

    function updateVisuals(role, dataArray) {
        if (!dataArray) return;

        const senderId = role === "A" ? "relay-A" : "relay-B";
        const receiverId = role === "A" ? "relay-B" : "relay-A";
        const activeColor = role === "A" ? COLOR_A : COLOR_B;

        // 1. Update SENDER Inner Ring (Inputs)
        for(let i=0; i<7; i++) {
            const dot = document.getElementById(`${senderId}-s-${i}`);
            const val = dataArray[i] || 0;
            if(dot) {
                // [CHANGED] Sensitivity: Cap at MAX_VAL (25)
                const intensity = Math.min(val / MAX_VAL, 1.0);
                
                // [CHANGED] Brighter floor (0.3)
                dot.style.opacity = 0.3 + (0.7 * intensity);
                
                if (val > 1) {
                    dot.style.backgroundColor = activeColor;
                    dot.style.boxShadow = `0 0 ${8 * intensity}px ${activeColor}`;
                } else {
                    dot.style.backgroundColor = "#3b2b26";
                    dot.style.boxShadow = "none";
                }
            }
        }

        // 2. Update RECEIVER Outer Ring (Outputs)
        const motorData = interpolateTo8(dataArray);
        motorData.forEach((val, i) => {
            const dot = document.getElementById(`${receiverId}-m-${i}`);
            if(dot) {
                const intensity = Math.min(val / MAX_VAL, 1.0);
                dot.style.opacity = 0.3 + (0.7 * intensity);
                
                if (val > 1) {
                    dot.style.backgroundColor = activeColor;
                    dot.style.boxShadow = `0 0 ${12 * intensity}px ${activeColor}`;
                } else {
                    dot.style.backgroundColor = "#7a5c4b";
                    dot.style.boxShadow = "none";
                }
            }
        });
    }

    // =================================================================
    // 5. CONNECTION
    // =================================================================
    function connectWS() {
        const els = {
            seal: document.getElementById("status-seal"),
            main: document.getElementById("status-main"),
            val: document.getElementById("main-value"),
            parsed: document.getElementById("metric-parsed"),
            logA: document.getElementById("log-A"),
            logB: document.getElementById("log-B"),
            cntTotal: document.getElementById("metric-count"),
            cntA: document.getElementById("metric-count-A"),
            cntB: document.getElementById("metric-count-B"),
        };

        if(els.seal) els.seal.classList.remove("online");

        const ws = new WebSocket(WS_URL);

        ws.onopen = () => {
            if(els.seal) {
                els.seal.classList.add("online");
                els.seal.querySelector("span").textContent = "‚ú®";
                els.main.textContent = "Link Established";
            }
        };

        ws.onmessage = (event) => {
            try {
                const packet = JSON.parse(event.data);
                if (!packet.role) return;

                let role = "Unknown";
                if (packet.role.includes("A")) role = "A";
                if (packet.role.includes("B")) role = "B";
                if(role === "Unknown") return;

                // Handle Data
                let data = [];
                if (Array.isArray(packet.data)) {
                    data = packet.data;
                } else {
                    const v = parseFloat(packet.data) || 0;
                    data = [v, 0, 0, 0, 0, 0, 0];
                }

                // --- UI UPDATES ---

                // 1. Chart
                const targetChart = role === "A" ? chartA : chartB;
                if (targetChart) {
                    const peak = Math.max(...data);
                    const ds = targetChart.data.datasets[0].data;
                    ds.shift();
                    ds.push(peak);
                    targetChart.update();

                    if(els.val) els.val.textContent = peak.toFixed(0);
                    if(els.parsed) els.parsed.textContent = `Peak: ${peak.toFixed(1)}`;
                }

                // 2. Counters [FIXED]
                msgCounts.total++;
                msgCounts[role]++;
                
                if(els.cntTotal) els.cntTotal.textContent = msgCounts.total;
                
                // Explicitly update the correct element
                if (role === "A" && els.cntA) els.cntA.textContent = msgCounts.A;
                if (role === "B" && els.cntB) els.cntB.textContent = msgCounts.B;

                // 3. Visuals
                updateVisuals(role, data);

                // 4. Logs
                const targetLog = role === "A" ? els.logA : els.logB;
                if (targetLog) {
                    const div = document.createElement("div");
                    div.className = "log-entry";
                    const clean = JSON.stringify(data.slice(0,4)).replace("]", ", ...]");
                    div.innerHTML = `<span class="time">[${new Date().toLocaleTimeString('en-GB')}]</span> <span class="text">${clean}</span>`;
                    targetLog.appendChild(div);
                    if(targetLog.children.length > 20) targetLog.removeChild(targetLog.firstChild);
                    targetLog.scrollTop = targetLog.scrollHeight;
                }

            } catch (e) { console.error(e); }
        };

        ws.onclose = () => {
            if(els.seal) els.seal.classList.remove("online");
            setTimeout(connectWS, 3000);
        };
    }
  </script>
  </body>
</html>
